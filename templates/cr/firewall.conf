family inet {
    filter border-in4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia4;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        term lvs-blackhole {
            from {
                source-prefix-list {
                    blackhole;
                }
                destination-prefix-list {
                    LVS-service-ips;
                }
            }
            then {
                discard;
            }
        }
        /* explicitly allow Auth DNS traffic; would normally be discarded by the DDoS UDP term below */
        term authdns {
            from {
                destination-address {
                    91.198.174.239/32;
                    208.80.154.238/32;
                    208.80.153.231/32;
                }
                protocol [ tcp udp ];
                port 53;
            }
            then accept;
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    208.80.154.250/32;
                }
                protocol tcp;
                destination-port 22;
            }
            then accept;
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol udp;
            }
            then {
                discard;
            }
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* workaround until lvs1001-lvs1007 are decom'ed */
        term protect-old-lvs-servers {
            from {
                destination-address {
                    208.80.154.55/32;
                    208.80.154.56/32;
                    208.80.154.57/32;
                    208.80.154.137/32;
                    208.80.154.138/32;
                    208.80.154.139/32;
                }
                protocol tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    208.80.155.69/32;
                    208.80.152.244/32;
                    198.35.26.244/32;
                }
            }
            then accept;
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                protocol tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter border-out4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in4 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private4;
                }
            }
            then {
                count deny-private-subnets4;
                reject administratively-prohibited;
            }
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback4 {
        term allow_ssh4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                    trusted-space4;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp4 {
            from {
                protocol tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf4 {
            from {
                protocol ospf;
            }
            then accept;
        }
        term allow_snmp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                }
                protocol udp;
                destination-port snmp;
            }
            then accept;
        }
        term allow_ntp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp4 {
            from {
                protocol icmp;
                icmp-type [ echo-request echo-reply unreachable time-exceeded source-quench ];
            }
            then {
                policer policer-2m;
                accept;
            }
        }
        term allow_vrrp4 {
            from {
                destination-address {
                    224.0.0.18/32;
                }
            }
            then accept;
        }
        term allow_pim4 {
            from {
                protocol pim;
            }
            then accept;
        }
        term allow_igmp4 {
            from {
                protocol igmp;
            }
            then accept;
        }
        term allow_dhcp4 {
            from {
                destination-port [ bootpc dhcp ];
            }
            then accept;
        }
        term allow_bfd4 {
            from {
                protocol udp;
                port 3784-3785;
            }
            then accept;
        }
        term allow_dns4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                source-port domain;
            }
            then accept;
        }
        term allow_junos_upgrades4 {
            from {
                source-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                source-port 80;
            }
            then accept;
        }
        term deny_all {
            then {
                discard;
            }
        }
    }
    {% if site == "eqiad" %}
    filter common-infrastructure4 {
        term puppet {
            from {
                destination-address {
                    /* puppetmaster1001 */
                    10.64.16.73/32;
                    /* puppetmaster2001 */
                    10.192.0.27/32;
                }
                protocol tcp;
                destination-port 8140;
            }
            then accept;
        }
        term apt {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port http;
            }
            then accept;
        }
        term webproxy {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port 8080;
            }
            then accept;
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term ntp {
            from {
                destination-port 123;
            }
            then accept;
        }
        term smtp {
            from {
                protocol tcp;
                destination-port 25;
            }
            then accept;
        }
        term ganglia {
            from {
                destination-address {
                    239.192.0.0/16;
                }
                protocol udp;
                destination-port 8649;
            }
            then accept;
        }
        term icinga {
            from {
                destination-address {
                    /* neon */
                    208.80.154.14/32;
                    /* tegmen */
                    208.80.153.74/32;
                    /* einsteinium */
                    208.80.155.119/32;
                }
            }
            then accept;
        }
        term igmp {
            from {
                protocol igmp;
            }
            then accept;
        }
        term ldap {
            from {
                destination-address {
                    208.80.154.79/32;
                    208.80.153.49/32;
                }
                protocol tcp;
                destination-port [ 389 636 ];
            }
            then accept;
        }
        term pim {
            from {
                destination-address {
                    224.0.0.13/32;
                }
                protocol pim;
                ttl 1;
            }
            then accept;
        }
        term cumin {
            from {
                destination-address {
                    /* neodymium */
                    10.64.32.20/32;
                    /* sarin */
                    10.192.0.140/32;
                }
                protocol tcp;
                source-port 22;
            }
            then accept;
        }
        term salt {
            from {
                destination-address {
                    /* neodymium */
                    10.64.32.20/32;
                    /* sarin */
                    10.192.0.140/32;
                }
                protocol tcp;
                destination-port [ 4505 4506 ];
            }
            then accept;
        }
        term git-deploy {
            from {
                destination-address {
                    10.64.0.196/32;
                    10.192.16.132/32;
                }
                protocol tcp;
                destination-port [ 80 443 6379 ];
            }
            then accept;
        }
        term tftp {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol udp;
                destination-port [ tftp 32768-61000 ];
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
    }
    filter analytics-in4 {
        term common-infrastructure {
            filter common-infrastructure4;
        }
        term analytics-subnets {
            from {
                destination-address {
                    10.64.36.0/24;
                    10.64.21.0/24;
                    10.64.5.0/24;
                    10.64.53.0/24;
                }
            }
            then accept;
        }
        term analytics-publicIP-v4 {
            from {
                destination-address {
                    208.80.154.11/32;
                    208.80.154.86/32;
                }
            }
            then accept;
        }
        term graphite {
            from {
                destination-address {
                    10.64.32.155/32;
                    10.192.16.33/32;
                }
                protocol [ udp tcp ];
                destination-port 2003;
            }
            then accept;
        }
        term ganglia_new {
            from {
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol [ udp tcp ];
                destination-port [ 9681 9694 ];
            }
            then accept;
        }
        term statsd {
            from {
                destination-address {
                    10.64.32.155/32;
                    10.192.16.33/32;
                }
                protocol udp;
                destination-port 8125;
            }
            then accept;
        }
        term mysql {
            from {
                destination-address {
                    10.64.16.36/32;
                    10.64.16.9/32;
                    10.64.0.166/32;
                    10.64.48.18/32;
                    10.64.16.20/32;
                    10.64.0.165/32;
                    10.64.16.35/32;
                    10.64.16.148/32;
                    10.192.32.19/32;
                    10.64.37.14/32;
                    10.64.37.15/32;
                    10.64.16.18/32;
                }
                protocol tcp;
                destination-port 3306;
            }
            then accept;
        }
        term ssh {
            from {
                destination-address {
                    208.80.154.15/32;
                    208.80.154.73/32;
                    10.64.32.135/32;
                    208.80.154.80/32;
                    10.64.48.18/32;
                    208.80.154.81/32;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term rsync-http-https {
            from {
                destination-address {
                    208.80.154.15/32;
                    208.80.154.73/32;
                    10.64.32.135/32;
                    208.80.154.80/32;
                    10.64.48.18/32;
                    208.80.154.81/32;
                    10.64.32.167/32;
                    10.64.0.21/32;
                    10.64.32.175/32;
                    10.192.32.131/32;
                }
                protocol tcp;
                destination-port [ 873 80 443 ];
            }
            then accept;
        }
        term return-tcp {
            from {
                protocol tcp;
                tcp-established;
            }
            then accept;
        }
        term kafka {
            from {
                destination-address {
                    /* kafka1001 */
                    10.64.0.11/32;
                    /* kafka1002 */
                    10.64.16.41/32;
                    /* kafka1003 */
                    10.64.32.127/32;
                    /* kafka2001 */
                    10.192.0.139/32;
                    /* kafka2002 */
                    10.192.16.169/32;
                    /* kafka2003 */
                    10.192.32.150/32;
                }
                protocol tcp;
                destination-port 9092;
            }
            then accept;
        }
        term archiva {
            from {
                destination-address {
                    208.80.154.73/32;
                }
                protocol tcp;
                destination-port [ 80 873 443 ];
            }
        }
        term logstash {
            from {
                destination-address {
                    10.64.32.137/32;
                    10.64.0.122/32;
                    10.64.48.113/32;
                }
                protocol udp;
                destination-port 12201;
            }
            then accept;
        }
        term gerritssh {
            from {
                destination-address {
                    208.80.154.81/32;
                }
                protocol tcp;
                destination-port 29418;
            }
            then accept;
        }
        term bacula {
            from {
                destination-address {
                    10.64.0.179/32;
                }
                destination-port 9103;
            }
            then accept;
        }
        term eventlogging_zeromq {
            from {
                destination-address {
                    10.64.32.167/32;
                }
                destination-port [ 8521-8523 8600 8421-8422 ];
            }
        }
        term zookeeper {
            from {
                destination-address {
                    10.64.0.18/32;
                    10.64.32.180/32;
                    10.64.48.111/32;
                }
                protocol tcp;
                destination-port [ 2181 2182 2183 ];
            }
            then accept;
        }
        /* T107576 */
        term labstore1003 {
            from {
                destination-address {
                    10.64.4.10/32;
                }
                protocol tcp;
                destination-port 873;
            }
            then accept;
        }
        /* T138609 for the 7000 port */
        term aqs {
            from {
                destination-address {
                    /* aqs100{4,5,6} */
                    10.64.0.107/32;
                    10.64.32.138/32;
                    10.64.48.146/32;
                    /* aqs100{4,5,6}-a */
                    10.64.0.126/32;
                    10.64.32.189/32;
                    10.64.48.148/32;
                    /* aqs100{4,5,6}-b */
                    10.64.0.127/32;
                    10.64.32.190/32;
                    10.64.48.149/32;
                    /* aqs100{7,8,9} */
                    10.64.0.199/32;
                    10.64.16.14/32;
                    10.64.48.119/32;
                    /* aqs100{7,8,9}-a */
                    10.64.0.213/32;
                    10.64.16.74/32;
                    10.64.48.122/32;
                    /* aqs100{7,8,9}-b */
                    10.64.0.237/32;
                    10.64.16.78/32;
                    10.64.48.123/32;
                }
                protocol tcp;
                destination-port 9042;
            }
            then accept;
        }
        term wdqs {
            from {
                destination-address {
                    /* wdqs1001 */
                    10.64.48.112/32;
                    /* wdqs1002 */
                    10.64.32.183/32;
                    /* wdqs1003 */
                    10.64.0.14/32;
                    /* wdqs2001 */
                    10.192.32.148/32;
                    /* wdqs2002 */
                    10.192.48.65/32;
                    /* wdqs2003 */
                    10.192.0.29/32;
                }
                protocol tcp;
                destination-port 8888;
            }
            then accept;
        }
        term ipsec {
            from {
                protocol esp;
            }
            then accept;
        }
        term ipsec-ike {
            from {
                protocol udp;
                destination-port 500;
            }
            then accept;
        }
        term icmp {
            from {
                protocol icmp;
            }
            then accept;
        }
        term udp-frag {
            from {
                fragment-offset 1-8191;
                protocol udp;
            }
            then accept;
        }
        /* Revert this when we get a good queue to undo T120281 */
        term es {
            from {
                destination-address {
                    /* elastic1017 */
                    10.64.48.39/32;
                    /* elastic1018 */
                    10.64.48.40/32;
                    /* elastic1019 */
                    10.64.48.41/32;
                    /* elastic1020 */
                    10.64.48.44/32;
                    /* elastic1021 */
                    10.64.48.45/32;
                    /* elastic1022 */
                    10.64.48.46/32;
                    /* elastic1023 */
                    10.64.48.47/32;
                    /* elastic1024 */
                    10.64.48.48/32;
                    /* elastic1025 */
                    10.64.48.49/32;
                    /* elastic1026 */
                    10.64.48.50/32;
                    /* elastic1027 */
                    10.64.48.51/32;
                    /* elastic1028 */
                    10.64.48.52/32;
                    /* elastic1029 */
                    10.64.48.53/32;
                    /* elastic1030 */
                    10.64.0.124/32;
                    /* elastic1031 */
                    10.64.0.125/32;
                    /* elastic2001 */
                    10.192.0.130/32;
                    /* elastic2002 */
                    10.192.0.131/32;
                    /* elastic2003 */
                    10.192.0.132/32;
                    /* elastic2004 */
                    10.192.0.133/32;
                    /* elastic2005 */
                    10.192.0.134/32;
                    /* elastic2006 */
                    10.192.0.135/32;
                    /* elastic2007 */
                    10.192.16.143/32;
                    /* elastic2008 */
                    10.192.16.144/32;
                    /* elastic2009 */
                    10.192.16.145/32;
                    /* elastic2010 */
                    10.192.16.146/32;
                    /* elastic2011 */
                    10.192.16.147/32;
                    /* elastic2012 */
                    10.192.16.148/32;
                    /* elastic2013 */
                    10.192.32.118/32;
                    /* elastic2014 */
                    10.192.32.119/32;
                    /* elastic2015 */
                    10.192.32.120/32;
                    /* elastic2016 */
                    10.192.32.121/32;
                    /* elastic2017 */
                    10.192.32.122/32;
                    /* elastic2018 */
                    10.192.32.123/32;
                    /* elastic2019 */
                    10.192.48.31/32;
                    /* elastic2020 */
                    10.192.48.32/32;
                    /* elastic2021 */
                    10.192.48.33/32;
                    /* elastic2022 */
                    10.192.48.34/32;
                    /* elastic2023 */
                    10.192.48.35/32;
                    /* elastic2024 */
                    10.192.48.36/32;
                    10.64.0.233/32;
                    10.64.0.234/32;
                    10.64.0.235/32;
                    10.64.0.236/32;
                    10.64.16.45/32;
                    10.64.16.46/32;
                    10.64.16.47/32;
                    10.64.16.48/32;
                    10.64.32.108/32;
                    10.64.32.109/32;
                    10.64.32.110/32;
                    10.64.32.111/32;
                    10.64.0.85/32;
                    10.64.0.86/32;
                    10.64.16.70/32;
                    10.64.16.71/32;
                    10.64.0.238/32;
                    10.64.16.111/32;
                    10.64.16.112/32;
                    10.64.32.21/32;
                    10.64.32.22/32;
                    10.192.0.77/32;
                    10.192.0.78/32;
                    10.192.0.79/32;
                    10.192.16.191/32;
                    10.192.16.192/32;
                    10.192.16.193/32;
                    10.192.32.156/32;
                    10.192.32.157/32;
                    10.192.32.158/32;
                    10.192.48.73/32;
                    10.192.48.74/32;
                    10.192.48.75/32;
                }
                protocol tcp;
                destination-port [ 9200 9243 ];
            }
            then accept;
        }
        term puppet {
            from {
                destination-address {
                    10.64.16.73/32;
                }
                destination-port 8140;
            }
            then accept;
        }
        term default {
            then {
                log;
                reject;
            }
        }
    }
    {% endif %}
    filter sandbox4 {
        term no-private {
            from {
                prefix-list {
                    private4;
                }
            }
            then {
                discard;
            }
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
        term icmp {
            from {
                protocol icmp;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
            }
            then {
                discard;
            }
        }
        term allow_rest {
            then accept;
        }
    }
    filter sandbox-out4 {
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in4 {
        term allow-vrrp {
            from {
                destination-address {
                    224.0.0.18/32;
                }
                protocol [ vrrp ah ];
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in4 {
        term allow-vrrp {
            filter vrrp-in4;
        }
        term ttl-check {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                ttl-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* labs-support1-a-eqiad */
                    10.64.4.0/24;
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                    /* labs-support1-c-eqiad */
                    10.64.37.0/24;
                }
            }
            then accept;
        }
        term allow-labs-instances {
            from {
                destination-address {
                    /* labs-instances1-b-eqiad */
                    10.68.16.0/21;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* puppetmaster1001 */
                    10.64.16.73/32;
                    /* puppetmaster2001 */
                    10.192.0.27/32;
                }
                protocol tcp;
                destination-port 8140;
            }
            then accept;
        }
        term prometheus {
            from {
                destination-address {
                    /* prometheus1001 */
                    10.64.32.197/32;
                    /* prometheus1002 */
                    10.64.32.198/32;
                    /* prometheus2001 */
                    10.192.16.181/32;
                    /* prometheus2002 */
                    10.192.16.182/32;
                }
                protocol tcp;
                source-port 9100;
            }
            then accept;
        }
        term cumin {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* neodymium */
                    10.64.32.20/32;
                    /* sarin */
                    10.192.0.140/32;
                }
                protocol tcp;
                source-port 22;
            }
            then accept;
        }
        term salt {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* neodymium */
                    10.64.32.20/32;
                    /* sarin */
                    10.192.0.140/32;
                }
                protocol tcp;
                destination-port [ 4505 4506 ];
            }
            then accept;
        }
        term labs_mysql {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* db1009 */
                    10.64.0.13/32;
                }
                protocol tcp;
                destination-port 3306;
            }
            then accept;
        }
        term allow_syslog {
            from {
                destination-address {
                    10.64.32.154/32;
                }
                destination-port 514;
            }
            then accept;
        }
        term allow_graphite {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-port [ 2003 2004 8125 ];
            }
            then accept;
        }
        term phab-git-ssh {
            from {
                destination-address {
                    208.80.154.250/32;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term no_ssh_public4 {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term inf-use-proxy {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* carbon */
                    208.80.154.10/32;
                    /* install1001 */
                    208.80.154.83/32;
                    /* install1002 */
                    208.80.154.86/32;
                    /* install2001 */
                    208.80.153.4/32;
                    /* install2002 */
                    208.80.153.53/32;
                }
                protocol tcp;
                destination-port [ 3128 8080 ];
            }
            then accept;
        }
        term instance-traffic {
            filter labs-instance-in4;
        }
        term default {
            filter deny-private-subnets-in4;
        }
    }
    /* Traffic from Labs instances can allow specifics here */
    filter labs-instance-in4 {
        term labstore {
            from {
                destination-address {
                    10.64.4.10/32;
                    10.64.37.6/32;
                    10.64.37.7/32;
                    10.64.37.10/32;
                    10.64.37.16/32;
                    10.64.37.17/32;
                    10.64.37.18/32;
                }
                protocol [ tcp udp ];
                port [ 38465-38567 55659 44153 111 2049 ];
            }
            then accept;
        }
        term labsdb-tcp4 {
            from {
                destination-address {
                    10.64.20.12/32;
                    10.64.37.4/32;
                    10.64.37.5/32;
                    10.64.37.8/32;
                    10.64.37.9/32;
                    10.64.37.11/32;
                    10.64.37.12/32;
                    10.64.4.11/32;
                    10.64.37.14/32;
                    10.64.37.15/32;
                }
                protocol tcp;
                port [ 3306-3309 5432 873 ];
            }
            then accept;
        }
        term labmon1001 {
            from {
                destination-address {
                    10.64.37.13/32;
                }
                protocol [ tcp udp ];
                destination-port [ 80 8125 2003 2004 ];
            }
            then accept;
        }
        term nobelium-elastic {
            from {
                destination-address {
                    10.64.37.14/32;
                }
                protocol tcp;
                destination-port 80;
            }
            then accept;
        }
       term scandium-git {
           from {
               destination-address {
                   10.64.4.12/32;
               }
               protocol tcp;
               destination-port 9418;
           }
           then accept;
       }
       term relforge {
           from {
               destination-address {
                   10.64.4.13/32;
                   10.64.37.21/32;
               }
               protocol tcp;
               destination-port 9243;
           }
           then accept;
       }
    }
    {% endif %}
}
family inet6 {
    filter border-in6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-in;
                discard;
            }
        }
        term lvs-blackhole {
            from {
                source-prefix-list {
                    blackhole;
                }
                destination-prefix-list {
                    LVS-service-ips6;
                }
            }
            then {
                discard;
            }
        }
        /* Deny outside traffic to our private IPv6 ranges */
        term our-private {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        /* reject traffic spoofed with our own source addresses */
        term own-space {
            from {
                source-prefix-list {
                    wikimedia6;
                }
            }
            then {
                count own-space;
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header udp;
            }
            then {
                discard;
            }
        }
        /* explicitly allow SSH traffic; would normally be discarded by the protect-lvs term below */
        term phab-git-ssh {
            from {
                destination-address {
                    2620:0:861:ed1a::3:16/128;
                }
                next-header tcp;
                destination-port 22;
            }
            then accept;
        }
        term protect-lvs {
            from {
                destination-prefix-list {
                    LVS-service-ips6;
                }
                next-header tcp;
                destination-port [ 22 179 9090 9100 ];
            }
            then {
                discard;
            }
        }
        /* RIPE Atlas wants access to 5666 which we block below */
        term ripe-atlas {
            from {
                destination-address {
                    2620:0:861:202:208:80:155:69/128;
                    2620:0:860:201:208:80:152:244/128;
                    2620:0:863:201:198:35:26:244/128;
                }
            }
            then accept;
        }
        /* reject webproxy for extra protection, as it's a gateway to prod - T122368 */
        term webproxy {
            from {
                destination-address {
                    /* carbon */
                    2620:0:861:1:208:80:154:10;
                    /* install1001 */
                    2620:0:861:3:208:80:154:83;
                    /* install1002 */
                    2620:0:861:3:208:80:154:86;
                    /* install2001 */
                    2620:0:860:1:208:80:153:4;
                    /* install2002 */
                    2620:0:860:2:208:80:153:53;
                }
                next-header tcp;
                destination-port [ 3128 8080 ];
            }
            then reject administratively-prohibited;
        }
        term nrpe {
            from {
                next-header tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter border-out6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges-out;
                discard;
            }
        }
        /* Deny outgoing traffic from private IPv6 ranges */
        term private {
            from {
                source-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in6 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                count deny-private-subnets-in6;
                log;
                reject administratively-prohibited;
            }
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback6 {
        term allow_ssh6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                    trusted-space6;
                }
                next-header tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp6 {
            from {
                next-header tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf6 {
            from {
                next-header ospf;
            }
            then accept;
        }
        term allow_snmp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                }
                next-header tcp;
                destination-port snmp;
            }
        }
        term allow_ntp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                }
                next-header udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp6 {
            from {
                next-header icmpv6;
            }
            then accept;
        }
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
        term allow_bfd6 {
            from {
                next-header udp;
                port 3784-3785;
            }
            then accept;
        }
        term allow_pim6 {
            from {
                next-header pim;
            }
            then accept;
        }
        term deny_other {
            then discard;
        }
    }
    filter sandbox6 {
        term no-private {
            from {
                prefix-list {
                    private6;
                }
            }
            then discard;
        }
        term dns {
            from {
                next-header udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                next-header [ vrrp ah ];
            }
            then accept;
        }
        term icmp {
            from {
                next-header icmp6;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
            }
            then discard;
        }
        term allow_rest {
            then accept;
        }
    }
    filter sandbox-out6 {
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in6 {
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in6 {
        term allow-vrrp {
            filter vrrp-in6;
        }
        inactive: term ttl-check {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                hop-limit-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                destination-address {
                    2620:0:861:117::/64;
                    2620:0:861:118::/64;
                    2620:0:861:119::/64;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* puppetmaster1001 */
                    2620:0:861:102:10:64:16:73/128;
                    /* puppetmaster2001 */
                    2620:0:860:101:10:192:0:27/128;
                }
                next-header tcp;
                destination-port 8140;
            }
            then accept;
        }
        term prometheus {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    2620:0:861:118::/64;
                }
                destination-address {
                    /* prometheus1001 */
                    2620:0:861:103:10:64:32:197/128;
                    /* prometheus1002 */
                    2620:0:861:103:10:64:32:198/128;
                    /* prometheus2001 */
                    2620:0:860:102:10:192:16:181/128;
                    /* prometheus2002 */
                    2620:0:860:102:10:192:16:182/128;
                }
                next-header tcp;
                source-port 9100;
            }
            then accept;
        }
        term no_ssh_public6 {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
                next-header tcp;
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term default {
            filter deny-private-subnets-in6;
        }
    }
    {% endif %}
}
policer policer-1m {
    if-exceeding {
        bandwidth-limit 1m;
        burst-size-limit 100k;
    }
    then discard;
}
policer policer-2m {
    if-exceeding {
        bandwidth-limit 2m;
        burst-size-limit 500k;
    }
    then discard;
}
