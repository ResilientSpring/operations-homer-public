family inet {
    filter border-in4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-addresses;
                discard;
            }
        }
        /* explicitly allow Auth DNS traffic; would normally be discarded by the DDoS UDP term below */
        term authdns {
            from {
                destination-address {
                    91.198.174.239/32;
                    208.80.154.238/32;
                    208.80.153.231/32;
                }
                protocol [ tcp udp ];
                port 53;
            }
            then accept;
        }
        term lvs-blackhole {
            from {
                source-address {
                    192.0.2.0/24;
                }
                destination-prefix-list {
                    LVS-service-ips;
                }
            }
            then {
                discard;
            }
        }
        term udp-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol udp;
            }
            then {
                discard;
            }
        }
        term ssh-lvs-ddos {
            from {
                destination-prefix-list {
                    LVS-service-ips;
                }
                protocol tcp;
                destination-port 22;
            }
            then {
                discard;
            }
        }
        term ripe-atlas {
            from {
                destination-address {
                    208.80.155.69/32;
                    208.80.152.244/32;
                    198.35.26.244/32;
                }
            }
            then accept;
        }
        term nrpe {
            from {
                protocol tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter border-out4 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges4;
                }
            }
            then {
                count special-ranges;
                discard;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in4 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private4;
                }
            }
            then {
                count deny-private-subnets4;
                reject administratively-prohibited;
            }
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback4 {
        term allow_ssh4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                    Trusted_Space4;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp4 {
            from {
                protocol tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf4 {
            from {
                protocol ospf;
            }
            then accept;
        }
        term allow_snmp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                    private4;
                }
                protocol udp;
                destination-port snmp;
            }
            then accept;
        }
        term allow_ntp4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp4 {
            from {
                protocol icmp;
                icmp-type [ echo-request echo-reply unreachable time-exceeded source-quench ];
            }
            then {
                policer policer-2m;
                accept;
            }
        }
        term allow_vrrp4 {
            from {
                destination-address {
                    224.0.0.18/32;
                }
            }
            then accept;
        }
        term allow_pim4 {
            from {
                protocol pim;
            }
            then accept;
        }
        term allow_igmp4 {
            from {
                protocol igmp;
            }
            then accept;
        }
        term allow_dhcp4 {
            from {
                destination-port [ bootpc dhcp ];
            }
            then accept;
        }
        term allow_bfd4 {
            from {
                protocol udp;
                port 3784-3785;
            }
            then accept;
        }
        term allow_dns4 {
            from {
                source-prefix-list {
                    wikimedia4;
                }
                protocol udp;
                source-port domain;
            }
            then accept;
        }
        term allow_junos_upgrades4 {
            from {
                source-address {
                    208.80.154.10/32;
                }
                protocol tcp;
                source-port 80;
            }
            then accept;
        }
        term deny_all {
            then {
                discard;
            }
        }
    }
    {% if site == "eqiad" %}
    filter common-infrastructure4 {
        term puppet {
            from {
                destination-address {
                    10.0.0.24/32;
                    10.0.0.245/32;
                    10.64.16.160/32;
                }
                protocol tcp;
                destination-port 8140;
            }
            then accept;
        }
        term apt {
            from {
                destination-address {
                    208.80.154.10/32;
                }
                protocol tcp;
                destination-port [ http 3128 8080 ];
            }
            then accept;
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term ntp {
            from {
                destination-port 123;
            }
            then accept;
        }
        term smtp {
            from {
                protocol tcp;
                destination-port 25;
            }
            then accept;
        }
        term ganglia {
            from {
                destination-address {
                    239.192.0.0/16;
                }
                protocol udp;
                destination-port 8649;
            }
            then accept;
        }
        term icinga {
            from {
                destination-address {
                    208.80.154.14/32;
                }
            }
            then accept;
        }
        term igmp {
            from {
                protocol igmp;
            }
            then accept;
        }
        term ldap {
            from {
                destination-address {
                    208.80.153.14/32;
                    208.80.154.6/32;
                }
                protocol tcp;
                destination-port [ 389 636 ];
            }
            then accept;
        }
        term pim {
            from {
                destination-address {
                    224.0.0.13/32;
                }
                protocol pim;
                ttl 1;
            }
            then accept;
        }
        term salt {
            from {
                destination-address {
                    10.64.16.160/32;
                }
                protocol tcp;
                destination-port [ 4506 4505 ];
            }
            then accept;
        }
        term git-deploy {
            from {
                destination-address {
                    10.64.0.196/32;
                }
                protocol tcp;
                destination-port [ 80 443 6379 ];
            }
            then accept;
        }
        term tftp {
            from {
                destination-address {
                    208.80.154.10/32;
                }
                protocol udp;
                destination-port [ tftp 32768-61000 ];
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
    }
    filter analytics-in4 {
        term common-infrastructure {
            filter common-infrastructure4;
        }
        term analytics-subnets {
            from {
                destination-address {
                    10.64.36.0/24;
                    10.64.21.0/24;
                    10.64.5.0/24;
                    10.64.53.0/24;
                }
            }
            then accept;
        }
        term analytics-publicIP-v4 {
            from {
                destination-address {
                    208.80.154.160/32;
                    208.80.154.90/32;
                    208.80.154.11/32;
                }
            }
            then accept;
        }
        term udplog {
            from {
                destination-address {
                    233.58.59.1/32;
                }
                protocol udp;
                destination-port 8420;
            }
            then accept;
        }
        term graphite {
            from {
                destination-address {
                    10.64.32.155/32;
                }
                protocol [ udp tcp ];
                destination-port 2003;
            }
            then accept;
        }
        term ganglia_new {
            from {
                destination-address {
                    208.80.154.10/32;
                }
                protocol [ udp tcp ];
                destination-port [ 9681 9694 ];
            }
            then accept;
        }
        term statsd {
            from {
                destination-address {
                    10.64.32.155/32;
                }
                protocol udp;
                destination-port 8125;
            }
            then accept;
        }
        term mysql {
            from {
                destination-address {
                    10.64.16.36/32;
                    10.64.16.9/32;
                    10.64.0.166/32;
                    10.64.48.18/32;
                    10.64.16.20/32;
                    10.64.0.165/32;
                    10.64.16.35/32;
                    10.64.16.148/32;
                }
                protocol tcp;
                destination-port 3306;
            }
            then accept;
        }
        term ssh {
            from {
                destination-address {
                    208.80.154.15/32;
                    208.80.154.73/32;
                    10.64.32.135/32;
                    208.80.154.80/32;
                    10.64.48.18/32;
                    208.80.154.81/32;
                }
                protocol tcp;
                destination-port ssh;
            }
            then accept;
        }
        term rsync-http-https {
            from {
                destination-address {
                    208.80.154.15/32;
                    208.80.154.73/32;
                    10.64.32.135/32;
                    208.80.154.80/32;
                    10.64.48.18/32;
                    208.80.154.81/32;
                    10.64.32.167/32;
                    10.64.0.21/32;
                }
                protocol tcp;
                destination-port [ 873 80 443 ];
            }
            then accept;
        }
        term return-tcp {
            from {
                protocol tcp;
                tcp-established;
            }
            then accept;
        }
        term icmp-echo-reply {
            from {
                protocol icmp;
                icmp-type echo-reply;
            }
            then accept;
        }
        term prelabsdb-mysql {
            from {
                destination-address {
                    10.64.32.23/32;
                    10.64.32.24/32;
                    10.64.32.27/32;
                }
                protocol tcp;
                destination-port [ 3306 3307 3308 ];
            }
            then accept;
        }
        term kafka {
            from {
                destination-address {
                    208.80.154.160/31;
                }
                protocol tcp;
                destination-port 9092;
            }
            then accept;
        }
        term archiva {
            from {
                destination-address {
                    208.80.154.154/32;
                }
                protocol tcp;
                destination-port [ 80 873 443 ];
            }
        }
        term logstash {
            from {
                destination-address {
                    10.64.32.136/32;
                    10.64.32.137/32;
                    10.64.32.138/32;
                }
                protocol udp;
                destination-port 12201;
            }
            then accept;
        }
        term gerritssh {
            from {
                destination-address {
                    208.80.154.81/32;
                }
                protocol tcp;
                destination-port 29418;
            }
            then accept;
        }
        term bacula {
            from {
                destination-address {
                    10.64.0.179/32;
                }
                destination-port 9103;
            }
            then accept;
        }
        term eventlogging_zeromq {
            from {
                destination-address {
                    10.64.32.167/32;
                }
                destination-port [ 8521-8523 8600 8421-8422 ];
            }
        }
        term zookeeper {
            from {
                destination-address {
                    10.64.0.18/32;
                    10.64.32.180/32;
                    10.64.48.111/32;
                }
                protocol tcp;
                destination-port [ 2181 2182 2183 ];
            }
            then accept;
        }
        term default {
            then {
                log;
                reject;
            }
        }
    }
    {% endif %}
    filter sandbox4 {
        term no-private {
            from {
                prefix-list {
                    private4;
                }
            }
            then {
                discard;
            }
        }
        term apt {
            from {
                destination-address {
                    208.80.154.10/32;
                }
                protocol tcp;
                destination-port [ http 3128 8080 ];
            }
            then accept;
        }
        term dns {
            from {
                protocol udp;
                destination-port 53;
            }
            then accept;
        }
        term tftp {
            from {
                destination-address {
                    208.80.154.10/32;
                }
                protocol udp;
                destination-port [ tftp 32768-61000 ];
            }
            then accept;
        }
        term vrrp {
            from {
                protocol [ vrrp ah ];
            }
            then accept;
        }
        term dhcp {
            from {
                protocol udp;
                destination-port dhcp;
            }
            then accept;
        }
        term icmp {
            from {
                protocol icmp;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
            }
            then {
                discard;
            }
        }
        term allow_rest {
            then accept;
        }
    }
    filter sandbox-out4 {
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in4 {
        term allow-vrrp {
            from {
                destination-address {
                    224.0.0.18/32;
                }
                protocol [ vrrp ah ];
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in4 {
        term allow-vrrp {
            filter vrrp-in4;
        }
        term ttl-check {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                ttl-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* labs-support1-a-eqiad */
                    10.64.4.0/24;
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                    /* labs-support1-c-eqiad */
                    10.64.37.0/24;
                }
            }
            then accept;
        }
        term allow-labs-instances {
            from {
                destination-address {
                    /* labs-instances1-b-eqiad */
                    10.68.16.0/21;
                }
            }
            then accept;
        }
        term puppetmaster {
            from {
                source-address {
                    10.64.20.0/24;
                }
                destination-address {
                    /* palladium */
                    10.64.16.160/32;
                }
                protocol tcp;
                destination-port [ 8140 4506 4505 ];
            }
            then accept;
        }
        term labs_mysql {
            from {
                source-address {
                    /* labs-hosts1-b-eqiad */
                    10.64.20.0/24;
                }
                destination-address {
                    /* db1009 */
                    10.64.0.13/32;
                }
                protocol tcp;
                destination-port 3306;
            }
            then accept;
        }
        term allow_syslog {
            from {
                destination-address {
                    10.64.32.154/32;
                }
                destination-port 514;
            }
            then accept;
        }
        term allow_graphite {
            from {
                destination-port [ 2003 2004 8125 ];
            }
            then accept;
        }
        term no_ssh_public4 {
            from {
                destination-prefix-list {
                    wikimedia4;
                }
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term instance-traffic {
            filter labs-instance-in4;
        }
        term default {
            filter deny-private-subnets-in4;
        }
    }
    /* Traffic from Labs instances can allow specifics here */
    filter labs-instance-in4 {
        term labstore {
            from {
                destination-address {
                    10.64.4.10/32;
                    10.64.37.6/32;
                    10.64.37.7/32;
                    10.64.37.10/32;
                }
                protocol [ tcp udp ];
                port [ 38465-38567 55659 44153 111 2049 ];
            }
            then accept;
        }
        term labsdb-tcp4 {
            from {
                destination-address {
                    10.64.20.12/32;
                    10.64.37.4/32;
                    10.64.37.5/32;
                    10.64.37.8/32;
                    10.64.37.9/32;
                    10.64.37.11/32;
                    10.64.37.12/32;
                    10.64.4.11/32;
                }
                protocol tcp;
                port [ 3306-3309 5432 873 ];
            }
            then accept;
        }
        term labmon1001 {
            from {
                destination-address {
                    10.64.37.13/32;
                }
                protocol [ tcp udp ];
                destination-port [ 80 8125 ];
            }
            then accept;
        }
    }
    {% endif %}
    {% if hostname == "cr1-codfw.wikimedia.org" %}
    filter mgmt-vlan {
        term iron {
            from {
                source-address {
                    208.80.154.151/32;
                }
            }
            then accept;
        }
        term netmon {
            from {
                source-address {
                    208.80.154.159/32;
                }
            }
            then accept;
        }
        term bast2001 {
            from {
                source-address {
                    208.80.153.5/32;
                }
            }
            then accept;
        }
        term carbon {
            from {
                source-address {
                    208.80.154.10/32;
                }
            }
            then accept;
        }
        term ntp {
            from {
                prefix-list {
                    system-ntp;
                }
            }
            then accept;
        }
        term nameservers {
            from {
                prefix-list {
                    system-nameservers;
                }
            }
            then accept;
        }
        term default {
            then {
                reject;
            }
        }
    }
    {% endif %}
}
family inet6 {
    filter border-in6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges;
                log;
                discard;
            }
        }
        /* Deny outside traffic to private IPv6 ranges */
        term private {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        term ripe-atlas {
            from {
                destination-address {
                    2620:0:861:202:208:80:155:69/128;
                    2620:0:860:201:208:80:152:244/128;
                    2620:0:863:201:198:35:26:244/128;
                }
            }
            then accept;
        }
        term nrpe {
            from {
                next-header tcp;
                destination-port 5666;
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter border-out6 {
        term special-ranges {
            from {
                prefix-list {
                    special-ranges6;
                }
            }
            then {
                count special-ranges;
                log;
                discard;
            }
        }
        /* Deny outgoing traffic from private IPv6 ranges */
        term private {
            from {
                source-prefix-list {
                    private6;
                }
            }
            then {
                reject administratively-prohibited;
            }
        }
        term default {
            then accept;
        }
    }
    filter deny-private-subnets-in6 {
        /* Deny any communication with private subnets */
        term deny-private-subnets {
            from {
                destination-prefix-list {
                    private6;
                }
            }
            then {
                count deny-private-subnets-in6;
                log;
                reject administratively-prohibited;
            }
        }
        /* Allow communication to public subnets and the Internet */
        term default {
            then accept;
        }
    }
    filter loopback6 {
        term allow_ssh6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                }
                next-header tcp;
                destination-port ssh;
            }
            then accept;
        }
        term allow_bgp6 {
            from {
                next-header tcp;
                port bgp;
            }
            then accept;
        }
        term allow_ospf6 {
            from {
                next-header ospf;
            }
            then accept;
        }
        term allow_snmp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                    private6;
                }
                next-header tcp;
                destination-port snmp;
            }
        }
        term allow_ntp6 {
            from {
                source-prefix-list {
                    wikimedia6;
                }
                next-header udp;
                destination-port ntp;
            }
            then accept;
        }
        term allow_ok_icmp6 {
            from {
                next-header icmpv6;
            }
            then accept;
        }
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
        term allow_bfd6 {
            from {
                next-header udp;
                port 3784-3785;
            }
            then accept;
        }
        term allow_pim6 {
            from {
                next-header pim;
            }
            then accept;
        }
        term deny_other {
            then discard;
        }
    }
    filter sandbox6 {
        term no-private {
            from {
                prefix-list {
                    private6;
                }
            }
            then discard;
        }
        term dns {
            from {
                next-header udp;
                destination-port 53;
            }
            then accept;
        }
        term vrrp {
            from {
                next-header [ vrrp ah ];
            }
            then accept;
        }
        term icmp {
            from {
                next-header icmp6;
            }
            then accept;
        }
        term reject_other_WMF_space {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
            }
            then discard;
        }
        term allow_rest {
            then accept;
        }
    }
    filter sandbox-out6 {
        term allow_rest {
            then accept;
        }
    }
    filter vrrp-in6 {
        term allow_vrrp6 {
            from {
                next-header vrrp;
            }
            then accept;
        }
    }
    {% if site == "eqiad" %}
    filter labs-in6 {
        term allow-vrrp {
            filter vrrp-in6;
        }
        inactive: term ttl-check {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                hop-limit-except 64;
            }
            then {
                count ttl-check;
                discard;
            }
        }
        term allow-labs {
            from {
                source-address {
                    2620:0:861:118::/64;
                }
                destination-address {
                    2620:0:861:117::/64;
                    2620:0:861:118::/64;
                    2620:0:861:119::/64;
                }
            }
            then accept;
        }
        term no_ssh_public6 {
            from {
                destination-prefix-list {
                    wikimedia6;
                }
                next-header tcp;
                destination-port ssh;
                tcp-initial;
            }
            then {
                reject;
            }
        }
        term default {
            filter deny-private-subnets-in6;
        }
    }
    {% endif %}
}
policer policer-1m {
    if-exceeding {
        bandwidth-limit 1m;
        burst-size-limit 100k;
    }
    then discard;
}
policer policer-2m {
    if-exceeding {
        bandwidth-limit 2m;
        burst-size-limit 500k;
    }
    then discard;
}
